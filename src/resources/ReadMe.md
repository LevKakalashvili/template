# Seed JSON — правила и допущения

Этот документ описывает **единый контракт** для JSON-файлов,
используемых для инициализации данных в БД через management-команды.

Документ является **основным источником правды** для формата seed-данных.

---

## Общие принципы

- Один JSON-файл = один независимый seed
- Все сущности и связи **должны быть описаны внутри одного файла**
- Ссылки между файлами запрещены
- Одна таблица / модель = один список сущностей в JSON

---

## `__key__`

`__key__` — **обязательное служебное поле**.

Назначение:
- используется **только для ссылок между сущностями внутри одного JSON**
- не сохраняется в БД
- не влияет на генерацию `id`

Требования:
- уникален **в рамках одного JSON файла**
- тип: строка

Пример:
```json
{ 
  "__key__": "pt:base_text",
  "name": "Base template"
}
```

---

## Поле `id`

`id` — **опциональное** поле.

Правила:
- `id` — **опциональное поле**.
- если `id` указан → запись создаётся / обновляется с этим `id`.
- если `id` отсутствует → `id` генерируется автоматически **детерминированно из `__key__`**
  (чтобы повторный импорт не создавал дубликаты).

---

## O2M (One-to-Many)

Связь O2M описывается **только** через поле `__children__`.

Любые списки вне `__children__` считаются **значениями полей**, а не связями.

Пример:
```json
{
  "ProjectTemplates": [
    {
      "__key__": "pt:base_text",
      "name": "Base template",
      "__children__": {
        "InterfaceSettings": [
          {
            "__key__": "is:base_text",
            "settings": [
              { "type": "checkbox", "name": "use_nested", "default": false }
            ]
          }
        ]
      }
    }
  ]
}
```

---

## FK-ссылки через `__key__`

Если поле является FK и его значение — строка,
совпадающая с `__key__` другой сущности,
загрузчик автоматически подставляет соответствующий `id`.

Пример:
```json
{
  "TemplateInterfaceSettings": [
    {
      "__key__": "tis:1",
      "template_id": "pt:base_text",
      "settings_id": "is:base_text"
    }
  ]
}
```

---

## M2M (Many-to-Many)

M2M **не определяется автоматически**.

Связь описывается **явно** через join-сущность
на верхнем уровне JSON (как обычная таблица).

Пример:
```json
{
  "TemplateInterfaceSettings": [
    {
      "__key__": "tis:1",
      "template_id": "pt:base_text",
      "settings_id": "is:base_text"
    }
  ]
}
```

Ограничения:
- сущности, на которые ссылается join-таблица,
  должны быть объявлены в этом же JSON файле

---

## Ограничения и допущения

- `__key__` используется только внутри одного JSON
- ссылки на сущности из других файлов запрещены
- порядок описания сущностей в JSON должен учитывать FK-зависимости:
  - сначала родительские сущности
  - затем дочерние
  - затем join-таблицы
- циклические обязательные FK не поддерживаются

---

## Резюме

Минимальный набор служебных правил:

- `__key__` — ссылки внутри JSON
- `id` — либо задан явно, либо генерируется
- `__children__` — единственный способ описать O2M
- M2M — только через явную join-сущность

Любая логика вне этих правил считается ошибкой конфигурации seed-данных.
