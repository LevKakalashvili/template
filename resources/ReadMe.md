# Формат JSON для инициализации данных

JSON используется для инициализации данных в БД и описывает:
- сущности (модели / таблицы),
- их поля,
- связи между сущностями.

Документ описывает **строгий контракт**, который используется загрузчиком данных.

---

## Общая структура

```json
{
  "ProjectTemplates": [
    {
      "__key__": "pt:base_text",
      "name": "Базовый шаблон текста"
    }
  ]
}
```

- Ключ верхнего уровня — **имя ORM-класса или имя таблицы в БД**
- Значение — **список сущностей**
- Каждая сущность — объект (`dict`)

---

## Служебные поля (стандартизированы)

### `__key__`

```json
"__key__": "some-unique-key"
```

- `__key__` — **обязательное поле** для каждой сущности в JSON.
- Используется как **внутренний идентификатор** для связей между сущностями **внутри JSON**.
- Не обязательно совпадает с `id` в БД.
- Все связи между сущностями в JSON строятся **только через `__key__`** (в значениях FK-полей).

### `__children__`

```json
"__children__": {
  "ChildModelOrTable": [ ... ]
}
```

- `__children__` — **опциональное поле**, используется **только для O2M** (вложенных сущностей).
- Любые списки вне `__children__` (включая `list[dict]`) считаются **значением поля**, а не связью.
  Это важно для JSONB/array-полей (например `settings: [{...}, {...}]`).

---

## Поле `id`

```json
"id": "uuid"
```

- `id` — **опциональное поле**.
- Если `id` указан → запись создаётся / обновляется с этим `id`.
- Если `id` отсутствует → `id` генерируется автоматически **детерминированно из `__key__`**
  (чтобы повторный импорт не создавал дубликаты).

---

## Правило для One-to-Many (O2M)

### ❗ ВАЖНОЕ ПРАВИЛО

**Вложенные сущности (O2M) описываются ТОЛЬКО через `__children__`.**

Пример:

```json
{
  "ProjectTemplates": [
    {
      "__key__": "pt:base_text",
      "name": "Базовый шаблон текста",
      "__children__": {
        "InterfaceSettings": [
          {
            "__key__": "is:base_text",
            "settings": [
              { "type": "checkbox", "name": "use_nested", "default": false }
            ]
          }
        ]
      }
    }
  ]
}
```

---

## Поля со списками (НЕ связь)

Пример JSONB поля `settings` (это значение поля, не O2M):

```json
{
  "InterfaceSettings": [
    {
      "__key__": "is:base_text",
      "settings": [
        { "type": "checkbox", "name": "use_nested", "default": false }
      ]
    }
  ]
}
```

---

## Правило для Many-to-Many (M2M)

- M2M связи описываются **через отдельную join-сущность** (третья сущность).
- Join-сущность хранится на верхнем уровне JSON как обычная сущность.
- Связи внутри join-сущности задаются **через `__key__`**.

Пример:

```json
{
  "ProjectTemplates": [
    { "__key__": "pt:base_text", "name": "Базовый шаблон текста" }
  ],

  "InterfaceSettings": [
    { "__key__": "is:base_text" }
  ],

  "TemplateInterfaceSettings": [
    {
      "__key__": "tis:pt:base_text:is:base_text",
      "template_id": "pt:base_text",
      "settings_id": "is:base_text"
    }
  ]
}
```

> Для “чистой” join-таблицы без дополнительных колонок корректное поведение при конфликте — `ON CONFLICT DO NOTHING`.

---

## Выбор файлов для загрузки (manifest)

Чтобы загрузчики были универсальными, используется файл:

`src/resources/seed_manifest.json`

Он определяет, какие JSON-файлы должна загружать каждая команда.

### Пример `seed_manifest.json`

```json
{
  "commands": {
    "init_project_templates": {
      "files": ["project_templates.json"]
    },
    "all": {
      "glob": "*.json",
      "exclude": ["seed_manifest.json"]
    }
  }
}
```

### Правила выбора файлов (приоритеты)

1. Если передан `--files` → загружаются только эти файлы
2. Если передан `--all` → загружаются все файлы по `glob`/`exclude`
3. Иначе берутся файлы из `commands.<command_name>.files`
4. Если секции команды нет → используется `commands.all`
5. Если и этого нет → fallback на `*.json`

---

## Примеры запуска

### Загрузить файлы по manifest для команды
```bash
python -m manager init_project_templates
```

### Явно указать файлы
```bash
python -m manager init_project_templates --files project_templates.json
```

### Загрузить все JSON из resources
```bash
python -m manager init_project_templates --all
```

---

## Итоговые правила (кратко)

1. `__key__` обязателен для каждой сущности
2. `id` опционален
3. Все связи строятся **только через `__key__`**
4. **O2M связи — только через `__children__`**
5. Любые списки вне `__children__` — это **значения полей**
6. M2M связи — только через join-сущность
